<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Sheet PRO</title> 
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4db8ff">

    <link rel="manifest" href="manifest.json">

    <link rel="icon" href="favicon-96x96.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 8px; 
            background-color: #f0f2f5; 
            margin: 0; 
            box-sizing: border-box; 
            font-size: 16px; 
            color: #000; 
        }
        * { box-sizing: border-box; }

        /* --- „É¨„Ç§„Ç¢„Ç¶„Éà --- */
        .app-grid { 
            display: flex; 
            gap: 12px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* --- „É°„Ç§„É≥„Éë„Éç„É´ --- */
        .calculator-container { 
            flex: 3; 
            min-width: 0; 
            background-color: #fff; 
            padding: 12px; 
            border-radius: 10px; 
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); 
            width: 100%; 
        }

        /* --- Ë°åÔºàRowÔºâ„ÅÆ„Éá„Ç∂„Ç§„É≥ --- */
        .row { 
            display: flex; 
            margin-bottom: 12px; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 10px; 
            background-color: #fff; 
            gap: 8px; 
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú: PC/„Çø„Éñ„É¨„ÉÉ„Éà */
        @media screen and (min-width: 801px) {
            .row { flex-direction: row; align-items: center; justify-content: space-between; }
            .text-label-input { flex: 1.5; }
            .calc-area { flex: 1; justify-content: center; }
            .result-area { flex: 2; justify-content: flex-end; background: #f8f9fa; padding: 5px 10px; border-radius: 6px; }
            .result-text { font-size: 1.6em; }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú: „Çπ„Éû„Éõ */
        @media screen and (max-width: 800px) {
            .row { flex-direction: column !important; align-items: stretch !important; }
            .text-label-input { width: 100% !important; font-size: 1.1em; padding: 10px; margin-bottom: 5px; }
            .calc-area { width: 100% !important; justify-content: center !important; padding: 10px 0; border-top: 1px dashed #eee; border-bottom: 1px dashed #eee; }
            .result-area { width: 100% !important; justify-content: space-between !important; background: #eefbff; padding: 12px; border-radius: 8px; }
            .result-text { font-size: 2.2em; }
        }

        /* --- ÂÖ•Âäõ„Éë„Éº„ÉÑ --- */
        .text-label-input { 
            padding: 8px; 
            border: 2px solid #000; 
            border-radius: 6px; 
            font-weight: bold; 
            color: #000; 
            outline: none; 
        }
        .calc-area { display: flex; align-items: center; gap: 8px; }
        
        .multiplier-input { 
            width: 110px; 
            font-size: 1.5em; 
            padding: 8px; 
            text-align: right; 
            border: 3px solid #007bff; 
            border-radius: 6px; 
            font-weight: bold; 
            color: #000; 
            outline: none; 
        }
        /* „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÅÆËâ≤„ÇíÂ∞ë„ÅóËñÑ„Åè„Åô„Çã */
        .multiplier-input::placeholder, .master-input::placeholder {
            color: #ccc;
            font-weight: normal;
        }
        
        .result-text { font-weight: bold; color: #007bff; }

        /* --- ÊºîÁÆóÂ≠ê„Ç≥„É≥„Éà„É≠„Éº„É´ --- */
        .operator-group { display: flex; flex-direction: column; align-items: center; width: 32px; }
        .operator-control { 
            font-size: 0.7em; 
            background: #333; 
            color: #fff; 
            width: 100%; 
            height: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border-radius: 3px; 
            cursor: pointer; 
        }
        .operator-display { 
            font-size: 1.6em; 
            font-weight: bold; 
            text-align: center; 
            color: #000; 
            height: 35px; 
            line-height: 35px; 
            width: 100%; 
        }

        /* --- „Éà„Ç∞„É´„Éú„Çø„É≥ --- */
        .percent-toggle, .base-toggle { 
            border: 2px solid #ccc; 
            border-radius: 6px; 
            width: 50px; 
            height: 50px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
            font-weight: bold; 
            background: #fff; 
            font-size: 1.3em; 
            flex-shrink: 0; 
            color: #000; 
            user-select: none; 
        }
        .percent-toggle.active { background: #dc3545; color: #fff; border-color: #dc3545; }
        .base-toggle.chain { background: #007bff; color: #fff; border-color: #007bff; }

        .action-btn { border: none; background: none; cursor: pointer; font-size: 1.8em; opacity: 0.7; padding: 5px; }

        /* --- ÊúÄ‰∏äÈÉ® „Éû„Çπ„Çø„ÉºË°å --- */
        .master-row { 
            padding: 12px; 
            margin-bottom: 12px; 
            border: 3px solid #dc3545; 
            border-radius: 10px; 
            background-color: #fff; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        .master-input { 
            width: 45%; 
            padding: 8px; 
            border: 2px solid #dc3545; 
            border-radius: 6px; 
            font-size: 1.5em; 
            text-align: right; 
            font-weight: bold; 
            color: #000; 
            outline: none; 
        }

        /* --- ‰øùÂ≠ò/„É°„É¢„É™„Éê„Éº --- */
        .storage-bar { 
            background: #dee2e6; 
            border: 2px solid #666; 
            border-radius: 10px; 
            padding: 10px; 
            margin-bottom: 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        .storage-controls { display: flex; align-items: center; gap: 10px; }
        .save-btn-main { background: #e67e22; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .edit-toggle-btn { background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.8em; }
        .edit-toggle-btn.active { background: #dc3545; }

        /* ‰øùÂ≠ò„É™„Çπ„ÉàÔºàÊ®™„Çπ„ÇØ„É≠„Éº„É´Ôºâ */
        .save-list-container { display: flex; gap: 6px; overflow-x: auto; padding: 4px 0; min-height: 45px; }
        .save-chip { 
            background: #fff; 
            border: 2px solid #007bff; 
            color: #000; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 0.85em; 
            font-weight: bold; 
            white-space: nowrap; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer; 
            user-select: none; 
        }
        .save-chip .del-icon { display: none; color: #dc3545; font-size: 1.3em; }
        .editing .save-chip { border-style: dashed; opacity: 0.8; }
        .editing .save-chip .del-icon { display: inline; }

        /* --- „Çµ„Ç§„ÉâÈõªÂçì --- */
        .side-calc { 
            flex: 1; 
            min-width: 280px; 
            background: #333; 
            padding: 12px; 
            border-radius: 10px; 
            color: white; 
            height: fit-content; 
            position: sticky; 
            top: 8px; 
        }
        .calc-display { 
            width: 100%; 
            height: 52px; 
            background: #222; 
            color: #fff; 
            text-align: right; 
            font-size: 1.8em; 
            padding: 8px; 
            border-radius: 6px; 
            margin-bottom: 8px; 
            border: none; 
            outline: none; 
        }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .calc-btn { 
            padding: 15px 5px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 1.25em; 
            font-weight: bold; 
            background: #555; 
            color: white; 
        }
        .calc-btn.op { background: #f39c12; }
        .calc-btn.equal { background: #27ae60; grid-column: span 2; }
        .calc-btn.clear { background: #c0392b; }

        /* „É¢„Éê„Ç§„É´Áî®ÈõªÂçì„Çπ„Çø„Ç§„É´ */
        @media screen and (max-width: 900px) {
            .side-calc { 
                display: none; 
                position: fixed; 
                bottom: 80px; 
                right: 15px; 
                z-index: 1000; 
                width: 280px; 
                box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            }
            .side-calc.active { display: block; }
        }

        /* --- „É¢„Éº„ÉâÂàáÊõø„Éú„Çø„É≥ --- */
        .mode-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
        .mode-button { 
            flex: 1; 
            padding: 12px 8px; 
            border: none; 
            background: #ddd; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 85px; 
            color: #000; 
            transition: 0.2s; 
        }
        .mode-button.active { background-color: #007bff; color: white; }
        .mode-desc { font-size: 0.7em; margin-top: 6px; opacity: 0.9; font-weight: normal; line-height: 1.3; text-align: center; }

        /* --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„Éú„Çø„É≥ --- */
        .util-btn { border: none; background: #6c757d; color: white; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: bold; }
        
        /* --- ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏ --- */
        #saveMessage { 
            position: fixed; 
            top: 15px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #000; 
            color: #fff; 
            padding: 12px 25px; 
            border-radius: 25px; 
            opacity: 0; 
            transition: opacity 0.3s; 
            z-index: 2000; 
            pointer-events: none; 
            font-weight: bold; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }

        /* --- „É¢„Éê„Ç§„É´Áî®ÈõªÂçìËµ∑Âãï„Éú„Çø„É≥ --- */
        .calc-toggle-btn { 
            display: none; 
            position: fixed; 
            bottom: 15px; 
            right: 15px; 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            background: #333; 
            color: white; 
            border: none; 
            font-size: 28px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            z-index: 1001; 
            cursor: pointer;
        }
        @media screen and (max-width: 900px) {
            .calc-toggle-btn { display: block; }
        }

        /* --- „É¢„Éê„Ç§„É´Áî®ÈõªÂçìÈñâ„Åò„Çã„Éú„Çø„É≥ --- */
        .mobile-calc-close {
            display: none;
            background: none; 
            border: none; 
            color: white; 
            font-size: 1.5em; 
            cursor: pointer;
        }
        @media screen and (max-width: 900px) {
            .mobile-calc-close { display: block; }
        }
    </style>
</head>
<body onload="init()">

    <div id="saveMessage"></div>
    
    <button class="calc-toggle-btn" onclick="toggleCalc()">üßÆ</button>

    <div class="app-grid">
        <div class="calculator-container">
            <div class="top-controls" style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px; flex-wrap: wrap; gap:8px;">
                <div style="flex:1; display:flex; align-items:center; border:2px solid #000; border-radius:6px; padding:6px 10px; min-width:180px; background:#fff;">
                    <span id="labelNameSpan" style="font-size:0.8em; color:#000; font-weight:bold; margin-right:8px;">Name:</span>
                    <input type="text" id="masterLabel" style="border:none; outline:none; font-weight:bold; width:100%; color:#000;" oninput="saveSettings()">
                </div>
                <div id="langContainer" style="display:flex; gap:3px; flex-wrap: wrap;"></div>
            </div>

            <div class="storage-bar">
                <div class="storage-controls">
                    <button class="save-btn-main" onclick="saveToMemory()">üíæ <span id="btnSaveMemory">Ë®òÊÜ∂„Åô„Çã</span></button>
                    <button id="editToggle" class="edit-toggle-btn" onclick="toggleEditMode()">Edit ‚úé</button>
                </div>
                <div id="saveList" class="save-list-container"></div>
            </div>

            <h2 id="title" style="font-weight: bold; margin-bottom: 12px;">Simple Sheet PRO</h2>

            <div class="utility-bar" style="display:flex; justify-content: center; gap:4px; margin-bottom:12px; flex-wrap:wrap;">
                <button class="util-btn" onclick="clearNumbers()">üßπ <span id="btnClear">Clear</span></button>
                <button class="util-btn" onclick="exportData()">üì§ <span id="btnExport">Exp</span></button>
                <button class="util-btn" onclick="importData()">üì• <span id="btnImport">Imp</span></button>
                <button class="util-btn" style="background:#dc3545;" onclick="fullReset()">üîÑ <span id="btnReset">Reset</span></button>
            </div>

            <div class="mode-toggle">
                <button id="smartSheetBtn" class="mode-button active" onclick="switchMode('smartSheet')">
                    <span id="txtModeBase">From Base</span>
                    <span id="descModeBase" class="mode-desc"></span>
                </button>
                <button id="customSimpleBtn" class="mode-button" onclick="switchMode('customSimple')">
                    <span id="txtModePrev">Flow</span>
                    <span id="descModePrev" class="mode-desc"></span>
                </button>
            </div>

            <div id="smart-sheet-mode">
                <div class="master-row">
                    <label id="masterLabelStart" style="font-weight:bold; color:#dc3545;">Base Value</label>
                    <input type="number" id="masterInput" class="master-input" step="any" placeholder="1000" oninput="updateDisplay()">
                </div>
                <div id="rows-container-smart"></div>
                <div style="text-align: center; margin-top: 15px; display: flex; gap: 8px;">
                    <button class="mode-button" id="addBtnInd" style="background:#28a745; color:white; flex-direction:row; min-height:auto;" onclick="addRowSmart()">+ Row</button>
                    <button class="mode-button" id="copyBtnInd" style="background:#007bff; color:white; flex-direction:row; min-height:auto;" onclick="copyPage('smart')">Copy All</button>
                </div>
            </div>

            <div id="custom-simple-mode" style="display: none;">
                <div class="master-row">
                    <label id="masterLabelStartSimple" style="font-weight:bold; color:#dc3545;">Base Value</label>
                    <input type="number" id="masterInputSimple" class="master-input" step="any" placeholder="1000" oninput="updateDisplay()">
                </div>
                <div id="rows-container-simple"></div>
                <div style="text-align: center; margin-top: 15px; display: flex; gap: 8px;">
                    <button class="mode-button" id="addBtnSeq" style="background:#28a745; color:white; flex-direction:row; min-height:auto;" onclick="addRowSimple()">+ Row</button>
                    <button class="mode-button" id="copyBtnSeq" style="background:#007bff; color:white; flex-direction:row; min-height:auto;" onclick="copyPage('custom')">Copy All</button>
                </div>
            </div>
        </div>

        <div id="sideCalc" class="side-calc">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 id="ui-calcTitle" style="margin:0;">Calculator</h3>
                <button class="mobile-calc-close" onclick="toggleCalc()">√ó</button>
            </div>
            
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="calcDisplay" class="calc-display" readonly value="0">
                <button class="calc-btn" style="background:#007bff; width:52px;" onclick="copyCalcResult()">üìã</button>
            </div>
            <div class="calc-buttons">
                <button class="calc-btn clear" onclick="calcClear()">AC</button>
                <button class="calc-btn op" onclick="calcInput('%')">%</button>
                <button class="calc-btn op" onclick="calcInput('/')">√∑</button>
                <button class="calc-btn op" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn op" onclick="calcInput('-')">-</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn op" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
                <button class="calc-btn" onclick="calcInput('0')">0</button>
                <button class="calc-btn clear" style="background:#e67e22;" onclick="calcBack()">C</button>
                <button class="calc-btn equal" onclick="calcResult()">=</button>
            </div>
        </div>
    </div>

    <script>
        // --- Ë®ÄË™ûÂÆöÁæ© ---
        const languageMap = {
            en: { title: "Simple Sheet PRO", modeBase: "From Base", descBase: "Fixed: All rows refer to the top base value", modePrev: "Flow", descPrev: "Sequential calc. Choose üè† or üîó for each row.", masterLabelName: "Name:", masterLabelStart: "Base Value", rowLabel: "Label", copyMsg: "Copied!", btnClear: "Clear", btnExport: "Exp", btnImport: "Imp", btnReset: "Reset", confirmReset: "Reset all?", addRow: "+ Row", copyAll: "Copy All", calcTitle: "Calculator", btnSave: "Save", msgSave: "Saved!", msgLoad: "Loaded!", confirmDel: "Delete this memory?", btnEdit: "Edit", btnDone: "Done", msgExported: "Exported!", promptImport: "Paste code:", msgError: "Error" },
            ja: { title: "Simple Sheet PRO", modeBase: "ÂÖÉ„ÅÆÂÄ§„Åã„Çâ", descBase: "Âõ∫ÂÆöÂèÇÁÖßÔºö„Åô„Åπ„Å¶„ÅÆË°å„Åå‰∏ÄÁï™‰∏ä„ÅÆÊï∞ÂÄ§„ÇíÂèÇÁÖß„Åó„Åæ„Åô", modePrev: "„Éï„É≠„ÉºË®àÁÆó", descPrev: "‰∏ä„Åã„ÇâÈ†Ü„Å´Ë®àÁÆó„ÄÇÂêÑË°å„Åß üè† „Åæ„Åü„ÅØ üîó „ÇíÈÅ∏ÊäûÂèØËÉΩ„ÄÇ", masterLabelName: "Ë®àÁÆóÂêç:", masterLabelStart: "ÂÖÉ„ÅÆÊï∞Â≠ó", rowLabel: "È†ÖÁõÆÂêç", copyMsg: "„Ç≥„Éî„ÉºÂÆå‰∫Ü", btnClear: "„ÇØ„É™„Ç¢", btnExport: "Âá∫Âäõ", btnImport: "Ë™≠Ëæº", btnReset: "ÂàùÊúüÂåñ", confirmReset: "ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", addRow: "+ Ë°åËøΩÂä†", copyAll: "ÂÖ®„Ç≥„Éî„Éº", calcTitle: "ÈõªÂçì", btnSave: "Ë®òÊÜ∂„Åô„Çã", msgSave: "Ë®òÊÜ∂„Åó„Åæ„Åó„Åü", msgLoad: "Ë™≠„ÅøËæº„Åø„Åæ„Åó„Åü", confirmDel: "„Åì„ÅÆË®òÊÜ∂„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", btnEdit: "Á∑®ÈõÜ", btnDone: "ÂÆå‰∫Ü", msgExported: "Âá∫Âäõ„Åó„Åæ„Åó„Åü", promptImport: "„Ç≥„Éº„Éâ„ÇíË≤º„Çä‰ªò„Åë:", msgError: "„Ç®„É©„Éº" },
            zh: { title: "Simple Sheet PRO", modeBase: "‰ªéÂàùÂßãÂÄº", descBase: "Âõ∫ÂÆöÂºïÁî®ÔºöÊØè‰∏ÄË°åÈÉΩÂºïÁî®È°∂ÈÉ®ÁöÑÂàùÂßãÂÄºËøõË°åËÆ°ÁÆó", modePrev: "ÊµÅÁ®ãÊ®°Âºè", descPrev: "Ëá™‰∏äËÄå‰∏ãËÆ°ÁÆó„ÄÇÊØèË°åÂèØÈÄâ üè† Êàñ üîó Ê®°Âºè„ÄÇ", masterLabelName: "ÂêçÁß∞:", masterLabelStart: "ÂàùÂßãÂÄº", rowLabel: "È°πÁõÆ", copyMsg: "Â∑≤Â§çÂà∂", btnClear: "Ê∏ÖÈô§", btnExport: "ÂØºÂá∫", btnImport: "ÂØºÂÖ•", btnReset: "ÈáçÁΩÆ", confirmReset: "Á°ÆËÆ§ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆÔºü", addRow: "+ Ê∑ªÂä†Ë°å", copyAll: "Â§çÂà∂ÂÖ®ÈÉ®", calcTitle: "ËÆ°ÁÆóÂô®", btnSave: "‰øùÂ≠ò", msgSave: "Â∑≤‰øùÂ≠ò", msgLoad: "Â∑≤Âä†ËΩΩ", confirmDel: "Âà†Èô§Ê≠§ËÆ∞ÂøÜÔºü", btnEdit: "ÁºñËæë", btnDone: "ÂÆåÊàê", msgExported: "Â∑≤ÂØºÂá∫", promptImport: "ËØ∑Á≤òË¥¥‰ª£Á†Å:", msgError: "ÈîôËØØ" },
            ko: { title: "Simple Sheet PRO", modeBase: "Í∏∞Ï§ÄÍ∞íÏóêÏÑú", descBase: "Í≥†Ï†ï Ï∞∏Ï°∞: Î™®Îì† ÌñâÏù¥ ÏµúÏÉÅÎã®Ïùò Í∏∞Ï§ÄÍ∞íÏùÑ Ï∞∏Ï°∞Ìï©ÎãàÎã§", modePrev: "ÌîåÎ°úÏö∞ Î™®Îìú", descPrev: "ÏàúÏ∞® Í≥ÑÏÇ∞. Í∞Å ÌñâÏóêÏÑú üè† ÎòêÎäî üîó ÏÑ†ÌÉù Í∞ÄÎä•.", masterLabelName: "Ïù¥Î¶Ñ:", masterLabelStart: "Í∏∞Ï§ÄÍ∞í", rowLabel: "Ìï≠Î™©Î™Ö", copyMsg: "Î≥µÏÇ¨Îê®", btnClear: "ÏßÄÏö∞Í∏∞", btnExport: "ÎÇ¥Î≥¥ÎÇ¥Í∏∞", btnImport: "Í∞ÄÏ†∏Ïò§Í∏∞", btnReset: "Ï¥àÍ∏∞Ìôî", confirmReset: "Ï†ÑÏ≤¥ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?", addRow: "+ Ìñâ Ï∂îÍ∞Ä", copyAll: "Ï†ÑÏ≤¥ Î≥µÏÇ¨", calcTitle: "Í≥ÑÏÇ∞Í∏∞", btnSave: "Ï†ÄÏû•", msgSave: "Ï†ÄÏû•Îê®", msgLoad: "Î°úÎìúÎê®", confirmDel: "ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?", btnEdit: "Ìé∏Ïßë", btnDone: "ÏôÑÎ£å", msgExported: "ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏôÑÎ£å", promptImport: "ÏΩîÎìúÎ•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî:", msgError: "Ïò§Î•ò" },
            es: { title: "Simple Sheet PRO", modeBase: "Desde Base", descBase: "Referencia fija: cada fila usa el valor inicial superior", modePrev: "Flujo", descPrev: "C√°lculo en cadena. Elige üè† o üîó por fila.", masterLabelName: "Nombre:", masterLabelStart: "Valor Base", rowLabel: "Etiqueta", copyMsg: "¬°Copiado!", btnClear: "Borrar", btnExport: "Exportar", btnImport: "Importar", btnReset: "Reiniciar", confirmReset: "¬øReiniciar todo?", addRow: "+ Fila", copyAll: "Copiar todo", calcTitle: "Calculadora", btnSave: "Guardar", msgSave: "¬°Guardado!", msgLoad: "¬°Cargado!", confirmDel: "¬øEliminar?", btnEdit: "Editar", btnDone: "Listo", msgExported: "¬°Exportado!", promptImport: "Pegar c√≥digo:", msgError: "Error" },
            fr: { title: "Simple Sheet PRO", modeBase: "Depuis Base", descBase: "R√©f. fixe : chaque ligne utilise la valeur du haut", modePrev: "Flux", descPrev: "Calcul en cha√Æne. Choisissez üè† ou üîó par ligne.", masterLabelName: "Nom :", masterLabelStart: "Valeur de base", rowLabel: "Libell√©", copyMsg: "Copi√© !", btnClear: "Effacer", btnExport: "Export", btnImport: "Import", btnReset: "R√†Z", confirmReset: "Tout r√©initialiser ?", addRow: "+ Ligne", copyAll: "Tout copier", calcTitle: "Calculatrice", btnSave: "Sauver", msgSave: "Enregistr√©", msgLoad: "Charg√©", confirmDel: "Supprimer ?", btnEdit: "Modifier", btnDone: "OK", msgExported: "Export√© !", promptImport: "Coller le code :", msgError: "Erreur" },
            pt: { title: "Simple Sheet PRO", modeBase: "Da Base", descBase: "Ref. fixa: cada linha usa o valor inicial do topo", modePrev: "Fluxo", descPrev: "C√°lculo em cadeia. Escolha üè† ou üîó por linha.", masterLabelName: "Nome:", masterLabelStart: "Valor Base", rowLabel: "R√≥tulo", copyMsg: "Copiado!", btnClear: "Limpar", btnExport: "Exportar", btnImport: "Importar", btnReset: "Reset", confirmReset: "Reiniciar tudo?", addRow: "+ Linha", copyAll: "Copiar tudo", calcTitle: "Calculadora", btnSave: "Salvar", msgSave: "Salvo", msgLoad: "Carregado", confirmDel: "Excluir?", btnEdit: "Editar", btnDone: "Concluir", msgExported: "Exportado!", promptImport: "Cole o c√≥digo:", msgError: "Erro" },
            de: { title: "Simple Sheet PRO", modeBase: "Vom Basiswert", descBase: "Feste Referenz: Jede Zeile nutzt den oberen Basiswert", modePrev: "Flow", descPrev: "Kettenrechnung. W√§hlen Sie üè† oder üîó pro Zeile.", masterLabelName: "Name:", masterLabelStart: "Basiswert", rowLabel: "Label", copyMsg: "Kopiert!", btnClear: "L√∂schen", btnExport: "Export", btnImport: "Import", btnReset: "Reset", confirmReset: "Alles zur√ºcksetzen?", addRow: "+ Zeile", copyAll: "Alles kopieren", calcTitle: "Rechner", btnSave: "Speichern", msgSave: "Gespeichert", msgLoad: "Geladen", confirmDel: "L√∂schen?", btnEdit: "Bearbeiten", btnDone: "Fertig", msgExported: "Exportiert!", promptImport: "Code einf√ºgen:", msgError: "Fehler" },
            it: { title: "Simple Sheet PRO", modeBase: "Dalla Base", descBase: "Rif. fisso: ogni riga usa il valore iniziale in alto", modePrev: "Flusso", descPrev: "Calcolo a catena. Scegli üè† o üîó per riga.", masterLabelName: "Nome:", masterLabelStart: "Valore Base", rowLabel: "Etichetta", copyMsg: "Copiato!", btnClear: "Cancella", btnExport: "Esporta", btnImport: "Importa", btnReset: "Reset", confirmReset: "Ripristinare tutto?", addRow: "+ Riga", copyAll: "Copia tutto", calcTitle: "Calcolatrice", btnSave: "Salva", msgSave: "Salvato", msgLoad: "Caricato", confirmDel: "Elimina?", btnEdit: "Modifica", btnDone: "Fatto", msgExported: "Esportato!", promptImport: "Incolla codice:", msgError: "Errore" }
        };
        let currentLanguage = 'ja'; 
        let isEditMode = false;
        let currentCalc = "0";

        // --- ÂàùÊúüÂåñ ---
        function init() {
            // Ë®ÄË™û„Éú„Çø„É≥ÁîüÊàê
            const langCont = document.getElementById('langContainer');
            Object.keys(languageMap).forEach(lang => {
                const btn = document.createElement('button');
                btn.style.cssText = "padding:4px 6px; font-size:11px; cursor:pointer; border:1px solid #ccc; border-radius:4px; background:#fff; font-weight:bold; color:#000;";
                btn.textContent = lang.toUpperCase();
                btn.onclick = () => setLanguage(lang);
                langCont.appendChild(btn);
            });

            // ‰øùÂ≠ò„Åï„Çå„ÅüË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
            const s = JSON.parse(localStorage.getItem('simpleSheetSettings') || '{}');
            applyData(s);
            setLanguage(localStorage.getItem('simpleSheetLang') || 'ja'); 
            renderSaveList();
        }

        // --- Ë®ÄË™ûË®≠ÂÆö ---
        function setLanguage(lang) {
            currentLanguage = lang; 
            localStorage.setItem('simpleSheetLang', lang);
            const d = languageMap[lang];
            
            // UI„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
            document.getElementById('title').textContent = d.title;
            document.getElementById('txtModeBase').textContent = d.modeBase;
            document.getElementById('descModeBase').textContent = d.descBase;
            document.getElementById('txtModePrev').textContent = d.modePrev;
            document.getElementById('descModePrev').textContent = d.descPrev;
            document.getElementById('labelNameSpan').textContent = d.masterLabelName;
            document.getElementById('masterLabelStart').textContent = d.masterLabelStart;
            document.getElementById('masterLabelStartSimple').textContent = d.masterLabelStart;
            document.getElementById('btnClear').textContent = d.btnClear;
            document.getElementById('btnExport').textContent = d.btnExport;
            document.getElementById('btnImport').textContent = d.btnImport;
            document.getElementById('btnReset').textContent = d.btnReset;
            document.getElementById('addBtnInd').textContent = d.addRow;
            document.getElementById('addBtnSeq').textContent = d.addRow;
            document.getElementById('copyBtnInd').textContent = d.copyAll;
            document.getElementById('copyBtnSeq').textContent = d.copyAll;
            document.getElementById('ui-calcTitle').textContent = d.calcTitle;
            document.getElementById('btnSaveMemory').textContent = d.btnSave;
            
            const editBtn = document.getElementById('editToggle');
            editBtn.textContent = isEditMode ? (d.btnDone + ' ‚úì') : (d.btnEdit + ' ‚úé');
            
            document.querySelectorAll('.text-label-input').forEach(input => {
                input.placeholder = d.rowLabel;
            });

            updateDisplay();
        }

        // --- Êï∞ÂÄ§„Éï„Ç©„Éº„Éû„ÉÉ„Éà ---
        function formatNum(num) {
            return num.toLocaleString(undefined, { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 3 
            });
        }

        // --- „É°„Ç§„É≥Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ ---
        function updateDisplay() {
            // Mode 1: Smart Sheet (Âõ∫ÂÆöÂèÇÁÖß)
            const mVal = parseFloat(document.getElementById('masterInput').value) || 0;
            document.querySelectorAll('#rows-container-smart .row').forEach(r => {
                const id = r.dataset.id;
                const op = document.getElementById('smart-op-'+id).textContent;
                const mult = parseFloat(r.querySelector('.multiplier-input').value) || 0;
                const pct = r.querySelector('.percent-toggle').classList.contains('active');
                
                let mod = pct ? mVal * (mult / 100) : mult;
                let res = 0;
                
                if(op === '+') res = mVal + mod;
                else if(op === '-') res = mVal - mod;
                else if(op === '√ó') res = pct ? mVal * (mult / 100) : mVal * mult;
                else if(op === '√∑') res = mult !== 0 ? mVal / mult : 0;
                
                r.querySelector('.result-text').textContent = formatNum(res);
            });

            // Mode 2: Flow (ÈÄ£ÈéñË®àÁÆó)
            const mValS = parseFloat(document.getElementById('masterInputSimple').value) || 0;
            let chain = mValS;
            document.querySelectorAll('#rows-container-simple .row').forEach(r => {
                const id = r.dataset.id;
                const op = document.getElementById('simple-op-'+id).textContent;
                const mult = parseFloat(r.querySelector('.multiplier-input').value) || 0;
                const pct = r.querySelector('.percent-toggle').classList.contains('active');
                const isChain = document.getElementById('simple-base-'+id).classList.contains('chain');
                
                // chain„É¢„Éº„Éâ„Å™„ÇâÂâç„ÅÆË°å„ÅÆÁµêÊûú„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞ÂàùÊúüÂÄ§„Çí‰Ωø„ÅÜ
                const base = isChain ? chain : mValS;
                let mod = pct ? base * (mult / 100) : mult;
                let res = 0;
                
                if(op === '+') res = base + mod;
                else if(op === '-') res = base - mod;
                else if(op === '√ó') res = pct ? base * (mult / 100) : base * mult;
                else if(op === '√∑') res = mult !== 0 ? base / mult : 0;
                
                r.querySelector('.result-text').textContent = formatNum(res);
                chain = res; // Ê¨°„ÅÆË°å„ÅÆ„Åü„ÇÅ„Å´ÁµêÊûú„ÇíÊõ¥Êñ∞
            });
            
            saveSettings();
        }

        // --- Á∑®ÈõÜ„É¢„Éº„ÉâÂàáÊõø ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('editToggle');
            const d = languageMap[currentLanguage];
            btn.classList.toggle('active', isEditMode);
            btn.textContent = isEditMode ? (d.btnDone + ' ‚úì') : (d.btnEdit + ' ‚úé');
            document.getElementById('saveList').classList.toggle('editing', isEditMode);
        }

        // --- „É°„É¢„É™‰øùÂ≠ò ---
        function saveToMemory() {
            const data = getScreenData();
            const name = data.masterLabel || "No Name";
            let lib = JSON.parse(localStorage.getItem('sheetLibrary_v3') || '[]');
            lib.push({ id: Date.now(), name: name, content: data });
            localStorage.setItem('sheetLibrary_v3', JSON.stringify(lib));
            renderSaveList();
            showMsg(languageMap[currentLanguage].msgSave);
        }

        // --- „É°„É¢„É™„É™„Çπ„ÉàË°®Á§∫ ---
        function renderSaveList() {
            const cont = document.getElementById('saveList');
            const lib = JSON.parse(localStorage.getItem('sheetLibrary_v3') || '[]');
            cont.innerHTML = '';
            lib.slice().reverse().forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'save-chip';
                
                // XSSÂØæÁ≠ñÊ∏à„Åø
                const nameSpan = document.createElement('span');
                nameSpan.textContent = item.name;
                
                const delIcon = document.createElement('span');
                delIcon.className = 'del-icon';
                delIcon.textContent = 'üóë';
                
                chip.appendChild(nameSpan);
                chip.appendChild(delIcon);
                
                chip.onclick = () => {
                    if(isEditMode) deleteMemory(item.id);
                    else { 
                        applyData(item.content); 
                        showMsg(languageMap[currentLanguage].msgLoad); 
                    }
                };
                cont.appendChild(chip);
            });
        }

        function deleteMemory(id) {
            if(confirm(languageMap[currentLanguage].confirmDel)) {
                let lib = JSON.parse(localStorage.getItem('sheetLibrary_v3') || '[]');
                lib = lib.filter(i => i.id !== id);
                localStorage.setItem('sheetLibrary_v3', JSON.stringify(lib));
                renderSaveList();
            }
        }

        // --- „Éá„Éº„ÇøÂèñÂæó ---
        function getScreenData() {
            return {
                masterLabel: document.getElementById('masterLabel').value,
                masterInput: document.getElementById('masterInput').value,
                masterInputSimple: document.getElementById('masterInputSimple').value,
                lastMode: document.getElementById('smartSheetBtn').classList.contains('active') ? 'smartSheet' : 'customSimple',
                smartRows: Array.from(document.querySelectorAll('#rows-container-smart .row')).map(r => ({
                    id: r.dataset.id, 
                    label: r.querySelector('.text-label-input').value, 
                    multiplier: r.querySelector('.multiplier-input').value, 
                    operator: document.getElementById('smart-op-'+r.dataset.id).textContent, 
                    isPercentActive: r.querySelector('.percent-toggle').classList.contains('active')
                })),
                simpleRows: Array.from(document.querySelectorAll('#rows-container-simple .row')).map(r => ({
                    id: r.dataset.id, 
                    label: r.querySelector('.text-label-input').value, 
                    multiplier: r.querySelector('.multiplier-input').value, 
                    operator: document.getElementById('simple-op-'+r.dataset.id).textContent, 
                    isPercentActive: r.querySelector('.percent-toggle').classList.contains('active'), 
                    baseMode: document.getElementById('simple-base-'+r.dataset.id).classList.contains('chain') ? 'chain' : 'master'
                }))
            };
        }

        // --- „Éá„Éº„ÇøÈÅ©Áî® ---
        function applyData(s) {
            if(!s || !s.smartRows) { 
                if(!document.querySelector('.row')) { addRowSmart(); addRowSimple(); }
                return; 
            }
            document.getElementById('masterLabel').value = s.masterLabel || '';
            document.getElementById('masterInput').value = s.masterInput || '';
            document.getElementById('masterInputSimple').value = s.masterInputSimple || '';
            
            document.getElementById('rows-container-smart').innerHTML = '';
            document.getElementById('rows-container-simple').innerHTML = '';
            s.smartRows.forEach(r => addRowSmart(r));
            s.simpleRows.forEach(r => addRowSimple(r));
            switchMode(s.lastMode || 'smartSheet');
            updateDisplay();
        }

        function saveSettings(){ 
            localStorage.setItem('simpleSheetSettings', JSON.stringify(getScreenData())); 
        }

        // --- Ë°åËøΩÂä†: Smart Mode ---
        function addRowSmart(s=null) {
            const id = s ? s.id : Math.random().toString(36).substr(2, 5);
            const ph = languageMap[currentLanguage].rowLabel;
            const div = document.createElement('div'); 
            div.className = 'row'; 
            div.dataset.id = id;
            const val = s ? s.multiplier : '';
            
            div.innerHTML = `
                <input type="text" class="text-label-input" placeholder="${ph}" value="${s?s.label:''}" oninput="saveSettings()">
                <div class="calc-area">
                    <div class="operator-group">
                        <div class="operator-control" onclick="changeOp('${id}','smart',1)">‚ñ≤</div>
                        <div class="operator-display" id="smart-op-${id}">${s?s.operator:'+'}</div>
                        <div class="operator-control" onclick="changeOp('${id}','smart',-1)">‚ñº</div>
                    </div>
                    <input type="number" step="any" class="multiplier-input" value="${val}" placeholder="0" oninput="updateDisplay()">
                    <div class="percent-toggle ${s&&s.isPercentActive?'active':''}" onclick="this.classList.toggle('active');updateDisplay()">%</div>
                </div>
                <div class="result-area">
                    <div class="result-text">0</div>
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn" onclick="copyRowVal(this)">üìã</button>
                        <button class="action-btn" onclick="this.closest('.row').remove();updateDisplay()">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            document.getElementById('rows-container-smart').appendChild(div); 
            updateDisplay();
        }

        // --- Ë°åËøΩÂä†: Flow Mode ---
        function addRowSimple(s=null) {
            const id = s ? s.id : Math.random().toString(36).substr(2, 5);
            const ph = languageMap[currentLanguage].rowLabel;
            const div = document.createElement('div'); 
            div.className = 'row'; 
            div.dataset.id = id;
            const isChain = s ? s.baseMode==='chain' : true;
            const val = s ? s.multiplier : '';

            div.innerHTML = `
                <input type="text" class="text-label-input" placeholder="${ph}" value="${s?s.label:''}" oninput="saveSettings()">
                <div class="calc-area">
                    <div id="simple-base-${id}" class="base-toggle ${isChain?'chain':''}" onclick="this.classList.toggle('chain');this.textContent=this.classList.contains('chain')?'üîó':'üè†';updateDisplay()">
                        ${isChain?'üîó':'üè†'}
                    </div>
                    <div class="operator-group">
                        <div class="operator-control" onclick="changeOp('${id}','simple',1)">‚ñ≤</div>
                        <div class="operator-display" id="simple-op-${id}">${s?s.operator:'+'}</div>
                        <div class="operator-control" onclick="changeOp('${id}','simple',-1)">‚ñº</div>
                    </div>
                    <input type="number" step="any" class="multiplier-input" value="${val}" placeholder="0" oninput="updateDisplay()">
                    <div class="percent-toggle ${s&&s.isPercentActive?'active':''}" onclick="this.classList.toggle('active');updateDisplay()">%</div>
                </div>
                <div class="result-area">
                    <div class="result-text">0</div>
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn" onclick="copyRowVal(this)">üìã</button>
                        <button class="action-btn" onclick="this.closest('.row').remove();updateDisplay()">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            document.getElementById('rows-container-simple').appendChild(div); 
            updateDisplay();
        }

        // --- „Éò„É´„Éë„ÉºÈñ¢Êï∞ ---
        function changeOp(id, m, d) { 
            const ops = ['+','-','√ó','√∑']; 
            const el = document.getElementById(m+'-op-'+id); 
            el.textContent = ops[(ops.indexOf(el.textContent) + d + 4) % 4]; 
            updateDisplay(); 
        }

        function switchMode(m) { 
            document.getElementById('smart-sheet-mode').style.display = m==='smartSheet' ? 'block' : 'none'; 
            document.getElementById('custom-simple-mode').style.display = m==='customSimple' ? 'block' : 'none'; 
            document.getElementById('smartSheetBtn').classList.toggle('active', m==='smartSheet'); 
            document.getElementById('customSimpleBtn').classList.toggle('active', m==='customSimple'); 
            updateDisplay(); 
        }
        
        function copyRowVal(btn) { 
            navigator.clipboard.writeText(btn.closest('.result-area').querySelector('.result-text').textContent.replace(/,/g,'')); 
            showMsg(languageMap[currentLanguage].copyMsg); 
        }

        function copyPage(m) { 
            let t = `„Äê${document.getElementById('masterLabel').value || 'Sheet'}„Äë\n`;
            const container = m === 'smart' ? '#rows-container-smart' : '#rows-container-simple';
            document.querySelectorAll(container + ' .row').forEach(r => { 
                t += `${r.querySelector('.text-label-input').value || '-'}\t${r.querySelector('.result-text').textContent.replace(/,/g,'')}\n`; 
            });
            navigator.clipboard.writeText(t); 
            showMsg(languageMap[currentLanguage].copyMsg);
        }

        // --- ÈõªÂçì„É≠„Ç∏„ÉÉ„ÇØ ---
        function calcInput(v) { 
            if(currentCalc === "0" && v !== ".") currentCalc = v; 
            else currentCalc += v; 
            document.getElementById('calcDisplay').value = currentCalc; 
        }
        function calcClear() { 
            currentCalc = "0"; 
            document.getElementById('calcDisplay').value = "0"; 
        }
        function calcBack() { 
            if(currentCalc.length > 1) { currentCalc = currentCalc.slice(0, -1); } 
            else { currentCalc = "0"; } 
            document.getElementById('calcDisplay').value = currentCalc; 
        }
        
        function calcResult() { 
            try { 
                let expression = currentCalc
                    .replace(/√ó/g, '*')
                    .replace(/√∑/g, '/')
                    .replace(/%/g, '/100');
                
                let res = eval(expression); 
                currentCalc = Number.isInteger(res) ? res.toString() : parseFloat(res.toFixed(8)).toString(); 
            } catch(e) { 
                currentCalc = "Error"; 
            } 
            document.getElementById('calcDisplay').value = currentCalc; 
        }
        
        function copyCalcResult() { 
            navigator.clipboard.writeText(document.getElementById('calcDisplay').value); 
            showMsg(languageMap[currentLanguage].copyMsg); 
        }
        function toggleCalc() { 
            document.getElementById('sideCalc').classList.toggle('active'); 
        }

        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Ê©üËÉΩ ---
        function clearNumbers() { 
            document.getElementById('masterInput').value = ""; 
            document.getElementById('masterInputSimple').value = ""; 
            document.querySelectorAll('.multiplier-input').forEach(i => i.value = ""); 
            updateDisplay(); 
        }
        function fullReset() { 
            if(confirm(languageMap[currentLanguage].confirmReset)) { 
                localStorage.clear(); 
                location.reload(); 
            } 
        }
        function showMsg(t) { 
            const m = document.getElementById('saveMessage'); 
            m.textContent = t; 
            m.style.opacity = 1; 
            setTimeout(() => m.style.opacity = 0, 1500); 
        }

        function exportData() { 
            const exportObj = { ...localStorage }; 
            navigator.clipboard.writeText(btoa(JSON.stringify(exportObj))); 
            // ‰øÆÊ≠£ÁÆáÊâÄÔºöÂ§öË®ÄË™û„É°„ÉÉ„Çª„Éº„Ç∏ÂØæÂøú
            showMsg(languageMap[currentLanguage].msgExported); 
        }
        function importData() { 
            // ‰øÆÊ≠£ÁÆáÊâÄÔºöÂ§öË®ÄË™û„Éó„É≠„É≥„Éó„ÉàÂØæÂøú
            const str = prompt(languageMap[currentLanguage].promptImport); 
            if(str) { 
                try {
                    const d = JSON.parse(atob(str)); 
                    Object.keys(d).forEach(k => localStorage.setItem(k, d[k])); 
                    location.reload();
                } catch(e) { 
                    // ‰øÆÊ≠£ÁÆáÊâÄÔºöÂ§öË®ÄË™û„Ç®„É©„ÉºÂØæÂøú
                    alert(languageMap[currentLanguage].msgError); 
                } 
            } 
        }

        // --- Service WorkerÁôªÈå≤ (PWAÂøÖÈ†à) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed', err));
            });
        }
    </script>
</body>
</html>
